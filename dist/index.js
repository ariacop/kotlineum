"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("react");function e(){var t={current:new Map},e={subscribe:function(n,r){return t.current.set(n,r),function(){return e.unsubscribe(n)}},unsubscribe:function(e){t.current.delete(e)},emit:function(e){t.current.forEach((function(t){return t(e)}))},getSubscriberCount:function(){return t.current.size}};return e}function n(){var e=t.useRef(new Map),n={subscribe:function(t,r){return e.current.set(t,r),function(){return n.unsubscribe(t)}},unsubscribe:function(t){e.current.delete(t)},emit:function(t){e.current.forEach((function(e){return e(t)}))},getSubscriberCount:function(){return e.current.size}},r=[function(t){return n.emit(t)},function(t){var e="sub-".concat(Math.random());return n.subscribe(e,t)}];return Object.assign(r,n),r}function r(t){var e={current:new Map},n=t,r={getValue:function(){return n},subscribe:function(t,o){return e.current.set(t,o),o(n),function(){return r.unsubscribe(t)}},unsubscribe:function(t){e.current.delete(t)},update:function(t){n=t,e.current.forEach((function(e){return e(t)}))},getSubscriberCount:function(){return e.current.size}};return r}var o=function(){function t(){this.flows=new Map}return t.getInstance=function(){return t.instance||(t.instance=new t),t.instance},t.prototype.getOrCreate=function(t){if(!this.flows.has(t)){var e=new Map,n={subscribe:function(t,r){return e.set(t,r),function(){return n.unsubscribe(t)}},unsubscribe:function(t){e.delete(t)},emit:function(t){e.forEach((function(e){return e(t)}))},getSubscriberCount:function(){return e.size}};this.flows.set(t,n)}return this.flows.get(t)},t.prototype.get=function(t){return this.flows.get(t)},t.prototype.has=function(t){return this.flows.has(t)},t}();function i(t){return o.getInstance().getOrCreate(t)}var s,u=function(){return u=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},u.apply(this,arguments)};function a(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{a(r.next(t))}catch(t){i(t)}}function u(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,u)}a((r=r.apply(t,e||[])).next())}))}function c(t,e){var n,r,o,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=u(0),s.throw=u(1),s.return=u(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function u(u){return function(a){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,u[0]&&(i=0)),i;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,r=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){i.label=u[1];break}if(6===u[0]&&i.label<o[1]){i.label=o[1],o=u;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(u);break}o[2]&&i.ops.pop(),i.trys.pop();continue}u=e.call(t,i)}catch(t){u=[6,t],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}}function l(t,e,n){if(n||2===arguments.length)for(var r,o=0,i=e.length;o<i;o++)!r&&o in e||(r||(r=Array.prototype.slice.call(e,0,o)),r[o]=e[o]);return t.concat(r||Array.prototype.slice.call(e))}"function"==typeof SuppressedError&&SuppressedError,exports.StorageType=void 0,(s=exports.StorageType||(exports.StorageType={})).LOCAL_STORAGE="localStorage",s.INDEXED_DB="indexedDB";var f=function(){function t(){}return t.openDatabase=function(t,e){var n=this;return new Promise((function(r,o){if(n.openConnections.has(t))r(n.openConnections.get(t));else if(window.indexedDB){var i=indexedDB.open(t,1);i.onerror=function(t){o(new Error("IndexedDB error: ".concat(t.target.error)))},i.onupgradeneeded=function(t){var n=t.target.result;n.objectStoreNames.contains(e)||n.createObjectStore(e)},i.onsuccess=function(e){var o=e.target.result;n.openConnections.set(t,o),window.addEventListener("beforeunload",(function(){o.close(),n.openConnections.delete(t)}),{once:!0}),r(o)}}else o(new Error("IndexedDB is not supported in this browser"))}))},t.getValue=function(t,e,n){var r=this;return new Promise((function(o,i){return a(r,void 0,void 0,(function(){var r,s,u,a,l;return c(this,(function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,this.openDatabase(t,e)];case 1:return r=c.sent(),s=r.transaction(e,"readonly"),u=s.objectStore(e),(a=u.get(n)).onsuccess=function(){o(a.result)},a.onerror=function(){i(a.error)},[3,3];case 2:return l=c.sent(),i(l),[3,3];case 3:return[2]}}))}))}))},t.setValue=function(t,e,n,r){var o=this;return new Promise((function(i,s){return a(o,void 0,void 0,(function(){var o,u,a,l,f;return c(this,(function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,this.openDatabase(t,e)];case 1:return o=c.sent(),u=o.transaction(e,"readwrite"),a=u.objectStore(e),(l=a.put(r,n)).onsuccess=function(){i()},l.onerror=function(){s(l.error)},[3,3];case 2:return f=c.sent(),s(f),[3,3];case 3:return[2]}}))}))}))},t.openConnections=new Map,t}();var p=function(){function t(){this.flows=new Map,this.persistOptions=new Map,this.debouncedSaveFunctions=new Map}return t.getInstance=function(){return t.instance||(t.instance=new t),t.instance},t.prototype.getOrCreate=function(e,n,r){var o,i,s,u=this;if(!this.flows.has(e)){var a=new Map;if(null==r?void 0:r.enabled){var c=r.storageKey||"kotlineum_state_".concat(e),l=r.storageType||exports.StorageType.LOCAL_STORAGE,f=r.dbName||"kotlineum_db",p=r.storeName||"kotlineum_store",d=r.debounceTime||300;this.persistOptions.set(e,{storageKey:c,enabled:!0,storageType:l,dbName:f,storeName:p,debounceTime:d,serialize:r.serialize||JSON.stringify,deserialize:r.deserialize||JSON.parse}),this.debouncedSaveFunctions.set(e,(o=function(t,n){return u.saveToStorage(e,t,n)},i=d,s=null,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];null!==s&&clearTimeout(s),s=setTimeout((function(){s=null,o.apply(void 0,t)}),i)}))}var h=n,b=this.persistOptions.get(e);(null==b?void 0:b.enabled)&&"undefined"!=typeof window&&this.loadFromStorage(e,b).then((function(t){void 0!==t&&u.flows.has(e)&&u.flows.get(e).update(t)})).catch((function(t){console.warn("Failed to load state from storage for key ".concat(e,":"),t)}));var w={getValue:function(){return h},subscribe:function(t,e){return a.set(t,e),e(h),function(){return w.unsubscribe(t)}},unsubscribe:function(t){a.delete(t)},update:function(n){h=n,a.forEach((function(t){return t(n)}));var r=t.getInstance().persistOptions.get(e);if((null==r?void 0:r.enabled)&&"undefined"!=typeof window){var o=t.getInstance().debouncedSaveFunctions.get(e);o&&o(n,r)}},getSubscriberCount:function(){return a.size}};this.flows.set(e,w)}return this.flows.get(e)},t.prototype.get=function(t){return this.flows.get(t)},t.prototype.has=function(t){return this.flows.has(t)},t.prototype.saveToStorage=function(t,e,n){try{if(n.storageType===exports.StorageType.INDEXED_DB){var r=n.serialize(e);f.setValue(n.dbName,n.storeName,n.storageKey,r).catch((function(e){console.warn("Failed to persist state to IndexedDB for key ".concat(t,":"),e)}))}else{r=n.serialize(e);localStorage.setItem(n.storageKey,r)}}catch(e){console.warn("Failed to persist state to storage for key ".concat(t,":"),e)}},t.prototype.loadFromStorage=function(t,e){return a(this,void 0,void 0,(function(){var t,n;return c(this,(function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),e.storageType!==exports.StorageType.INDEXED_DB?[3,2]:[4,f.getValue(e.dbName,e.storeName,e.storageKey)];case 1:return(t=r.sent())?[2,e.deserialize(t)]:[3,3];case 2:if(n=localStorage.getItem(e.storageKey))return[2,e.deserialize(n)];r.label=3;case 3:return[3,5];case 4:throw r.sent();case 5:return[2,void 0]}}))}))},t}();function d(t,e,n){return p.getInstance().getOrCreate(t,e,n)}var h=function(){function t(t,e,n){void 0===e&&(e=[]),void 0===n&&(n={}),this.key=t,this.itemStateFlows=new Map,this.idField=n.idField||"id",this.stateFlow=d(t,e,n.persistOptions),this.initializeItemFlows(e)}return t.prototype.initializeItemFlows=function(t){var e=this;this.itemStateFlows.clear(),t.forEach((function(t){var n=String(t[e.idField]),r=d("".concat(e.key,"_item_").concat(n),t);e.itemStateFlows.set(n,r)}))},t.prototype.getItems=function(){return this.stateFlow.getValue()},t.prototype.getItem=function(t){var e=String(t),n=this.itemStateFlows.get(e);return n?n.getValue():void 0},t.prototype.updateItems=function(t){this.stateFlow.update(t),this.initializeItemFlows(t)},t.prototype.updateItem=function(t,e){var n=this,r=String(t),o=this.itemStateFlows.get(r);if(o){var i=e(o.getValue());o.update(i);var s=this.stateFlow.getValue().map((function(t){return String(t[n.idField])===r?i:t}));this.stateFlow.update(s)}},t.prototype.addItem=function(t){var e=String(t[this.idField]),n=d("".concat(this.key,"_item_").concat(e),t);this.itemStateFlows.set(e,n);var r=this.stateFlow.getValue();this.stateFlow.update(l(l([],r,!0),[t],!1))},t.prototype.removeItem=function(t){var e=this,n=String(t);this.itemStateFlows.delete(n);var r=this.stateFlow.getValue().filter((function(t){return String(t[e.idField])!==n}));this.stateFlow.update(r)},t.prototype.subscribeToList=function(t,e){return this.stateFlow.subscribe(t,e)},t.prototype.subscribeToItem=function(t,e,n){var r=String(t),o=this.itemStateFlows.get(r);return o?o.subscribe(e,n):function(){}},t.prototype.batchUpdate=function(t){var e=this,n=l([],this.stateFlow.getValue(),!0);t.forEach((function(t){var r=t.id,o=t.update,i=String(r),s=e.itemStateFlows.get(i);if(s){var u=o(s.getValue());s.update(u),n=n.map((function(t){return String(t[e.idField])===i?u:t}))}})),this.stateFlow.update(n)},t.prototype.filter=function(t){return this.stateFlow.getValue().filter(t)},t.prototype.map=function(t){return this.stateFlow.getValue().map(t)},Object.defineProperty(t.prototype,"size",{get:function(){return this.stateFlow.getValue().length},enumerable:!1,configurable:!0}),t}();function b(t,e,n){return void 0===e&&(e=[]),void 0===n&&(n={}),new h(t,e,n)}var w=function(){function t(t){this.isDisposed=!1,this.stateFlow=r({data:t,loading:!1,error:null}),this.eventsFlow=e()}return t.prototype.getState=function(){return this.stateFlow.getValue()},t.prototype.getData=function(){return this.stateFlow.getValue().data},t.prototype.subscribeToState=function(t,e){return this.stateFlow.subscribe(t,e)},t.prototype.subscribeToEvents=function(t,e){return this.eventsFlow.subscribe(t,e)},t.prototype.setLoading=function(t){this.stateFlow.update(u(u({},this.stateFlow.getValue()),{loading:t}))},t.prototype.setError=function(t){this.stateFlow.update(u(u({},this.stateFlow.getValue()),{error:t}))},t.prototype.updateData=function(t){this.stateFlow.update(u(u({},this.stateFlow.getValue()),{data:t}))},t.prototype.updateState=function(t){this.stateFlow.update(u(u({},this.stateFlow.getValue()),t))},t.prototype.emitEvent=function(t){this.eventsFlow.emit(t)},t.prototype.dispose=function(){this.isDisposed||(this.onDispose(),this.isDisposed=!0)},t.prototype.onDispose=function(){},t}(),g=function(){function t(){this.viewModels=new Map}return t.getInstance=function(){return t.instance||(t.instance=new t),t.instance},t.prototype.get=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!this.viewModels.has(t)){var o=new(e.bind.apply(e,l([void 0],n,!1)));return this.viewModels.set(t,o),o}return this.viewModels.get(t)},t.prototype.has=function(t){return this.viewModels.has(t)},t.prototype.remove=function(t){if(this.viewModels.has(t)){var e=this.viewModels.get(t);null==e||e.dispose(),this.viewModels.delete(t)}},t.prototype.clear=function(){this.viewModels.forEach((function(t){return t.dispose()})),this.viewModels.clear()},t}();function v(e,n){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];var i=g.getInstance(),s=i.get.apply(i,l([e,n],r,!1)),u=t.useState(s.getState()),a=u[0],c=u[1],f=t.useRef("vm-".concat(e,"-").concat(Math.random()));return t.useEffect((function(){var t=s.subscribeToState(f.current,c);return function(){t()}}),[s]),[a,s]}exports.GlobalListStateFlow=b,exports.GlobalSharedFlow=i,exports.GlobalStateFlow=d,exports.ListStateFlow=h,exports.SharedFlow=e,exports.StateFlow=r,exports.ViewModel=w,exports.ViewModelProvider=g,exports.useGlobalListStateFlow=function(e,n,r){void 0===n&&(n=[]),void 0===r&&(r={});var o=b(e,n,r),i=t.useState(o.getItems()),s=i[0],u=i[1];return t.useEffect((function(){var t=o.subscribeToList("hook-".concat(e,"-").concat(Math.random()),(function(t){u(t)}));return u(o.getItems()),t}),[e,o]),[s,o]},exports.useGlobalSharedFlow=function(e,n){var r=i(e);return t.useEffect((function(){var t;return n&&(t=r.subscribe("hook-".concat(e,"-").concat(Math.random()),n)),function(){t&&t()}}),[e,n]),[function(t){return r.emit(t)},function(t){return r.subscribe("sub-".concat(e,"-").concat(Math.random()),t)}]},exports.useGlobalSharedFlowWithState=function(e,n){var r=t.useState(n),o=r[0],s=r[1],u=i(e);return t.useEffect((function(){return u.subscribe("state-".concat(e,"-").concat(Math.random()),(function(t){return s(t)}))}),[e]),[o,function(t){return u.emit(t)}]},exports.useGlobalStateFlow=function(e,n,r){var o=t.useState(n),i=o[0],s=o[1],u=d(e,n,r);return t.useEffect((function(){var t=u.subscribe("hook-".concat(e,"-").concat(Math.random()),(function(t){s(t)}));return s(u.getValue()),t}),[e,n]),[i,function(t){return u.update(t)}]},exports.useGlobalViewModel=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var o="global-".concat(t);return v.apply(void 0,l([o,e],n,!1))},exports.useListItem=function(e,n){var r=t.useState(e.getItem(n)),o=r[0],i=r[1];return t.useEffect((function(){var t=e.subscribeToItem(n,"item-hook-".concat(n,"-").concat(Math.random()),(function(t){i(t)}));return i(e.getItem(n)),t}),[e,n]),[o,function(t){o&&e.updateItem(n,t)}]},exports.useListStateFlow=function(t,e,n){return void 0===e&&(e=[]),void 0===n&&(n={}),new h(t,e,n)},exports.useSharedFlow=n,exports.useSharedFlowWithState=function(e){var r=t.useState(e),o=r[0],i=r[1],s=n();return t.useRef((function(){s.subscribe("internal-state",(function(t){return i(t)}))})).current(),[o,s.emit,function(t){return s.subscribe("sub-".concat(Math.random()),t)}]},exports.useStateFlow=function(e){var n=t.useState(e),r=n[0],o=n[1],i=t.useRef(new Map),s={getValue:function(){return r},subscribe:function(t,e){return i.current.set(t,e),e(r),function(){return s.unsubscribe(t)}},unsubscribe:function(t){i.current.delete(t)},update:function(t){o(t),i.current.forEach((function(e){return e(t)}))},getSubscriberCount:function(){return i.current.size}},u=[r,s.update];return Object.assign(u,s),u},exports.useViewModel=v;
//# sourceMappingURL=index.js.map

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react");function t(){var e={current:new Map},t={subscribe:function(n,r){return e.current.set(n,r),function(){return t.unsubscribe(n)}},unsubscribe:function(t){e.current.delete(t)},emit:function(t){e.current.forEach((function(e){return e(t)}))},getSubscriberCount:function(){return e.current.size}};return t}function n(){var t=e.useRef(new Map),n={subscribe:function(e,r){return t.current.set(e,r),function(){return n.unsubscribe(e)}},unsubscribe:function(e){t.current.delete(e)},emit:function(e){t.current.forEach((function(t){return t(e)}))},getSubscriberCount:function(){return t.current.size}},r=[function(e){return n.emit(e)},function(e){var t="sub-".concat(Math.random());return n.subscribe(t,e)}];return Object.assign(r,n),r}function r(e){var t={current:new Map},n=e,r={getValue:function(){return n},subscribe:function(e,o){return t.current.set(e,o),o(n),function(){return r.unsubscribe(e)}},unsubscribe:function(e){t.current.delete(e)},update:function(e){n=e,t.current.forEach((function(t){return t(e)}))},getSubscriberCount:function(){return t.current.size}};return r}var o=function(){function e(){this.flows=new Map}return e.getInstance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.getOrCreate=function(e){if(!this.flows.has(e)){var t=new Map,n={subscribe:function(e,r){return t.set(e,r),function(){return n.unsubscribe(e)}},unsubscribe:function(e){t.delete(e)},emit:function(e){t.forEach((function(t){return t(e)}))},getSubscriberCount:function(){return t.size}};this.flows.set(e,n)}return this.flows.get(e)},e.prototype.get=function(e){return this.flows.get(e)},e.prototype.has=function(e){return this.flows.has(e)},e}();function s(e){return o.getInstance().getOrCreate(e)}var u,i=function(){return i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},i.apply(this,arguments)};function a(e,t,n,r){return new(n||(n=Promise))((function(o,s){function u(e){try{a(r.next(e))}catch(e){s(e)}}function i(e){try{a(r.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,i)}a((r=r.apply(e,t||[])).next())}))}function c(e,t){var n,r,o,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},u=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return u.next=i(0),u.throw=i(1),u.return=i(2),"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function i(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;u&&(u=0,i[0]&&(s=0)),s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function f(e,t,n){if(n||2===arguments.length)for(var r,o=0,s=t.length;o<s;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))}"function"==typeof SuppressedError&&SuppressedError,exports.StorageType=void 0,(u=exports.StorageType||(exports.StorageType={})).LOCAL_STORAGE="localStorage",u.INDEXED_DB="indexedDB";var l=function(){function e(){}return e.openDatabase=function(e,t){var n=this;return new Promise((function(r,o){if(n.openConnections.has(e))r(n.openConnections.get(e));else if(window.indexedDB){var s=indexedDB.open(e,1);s.onerror=function(e){o(new Error("IndexedDB error: ".concat(e.target.error)))},s.onupgradeneeded=function(e){var n=e.target.result;n.objectStoreNames.contains(t)||n.createObjectStore(t)},s.onsuccess=function(t){var o=t.target.result;n.openConnections.set(e,o),window.addEventListener("beforeunload",(function(){o.close(),n.openConnections.delete(e)}),{once:!0}),r(o)}}else o(new Error("IndexedDB is not supported in this browser"))}))},e.getValue=function(e,t,n){var r=this;return new Promise((function(o,s){return a(r,void 0,void 0,(function(){var r,u,i,a,f;return c(this,(function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,this.openDatabase(e,t)];case 1:return r=c.sent(),u=r.transaction(t,"readonly"),i=u.objectStore(t),(a=i.get(n)).onsuccess=function(){o(a.result)},a.onerror=function(){s(a.error)},[3,3];case 2:return f=c.sent(),s(f),[3,3];case 3:return[2]}}))}))}))},e.setValue=function(e,t,n,r){var o=this;return new Promise((function(s,u){return a(o,void 0,void 0,(function(){var o,i,a,f,l;return c(this,(function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,this.openDatabase(e,t)];case 1:return o=c.sent(),i=o.transaction(t,"readwrite"),a=i.objectStore(t),(f=a.put(r,n)).onsuccess=function(){s()},f.onerror=function(){u(f.error)},[3,3];case 2:return l=c.sent(),u(l),[3,3];case 3:return[2]}}))}))}))},e.openConnections=new Map,e}();var p=function(){function e(){this.flows=new Map,this.persistOptions=new Map,this.debouncedSaveFunctions=new Map}return e.getInstance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.getOrCreate=function(t,n,r){var o,s,u,i=this;if(!this.flows.has(t)){var a=new Map;if(null==r?void 0:r.enabled){var c=r.storageKey||"kotlineum_state_".concat(t),f=r.storageType||exports.StorageType.LOCAL_STORAGE,l=r.dbName||"kotlineum_db",p=r.storeName||"kotlineum_store",d=r.debounceTime||300;this.persistOptions.set(t,{storageKey:c,enabled:!0,storageType:f,dbName:l,storeName:p,debounceTime:d,serialize:r.serialize||JSON.stringify,deserialize:r.deserialize||JSON.parse}),this.debouncedSaveFunctions.set(t,(o=function(e,n){return i.saveToStorage(t,e,n)},s=d,u=null,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];null!==u&&clearTimeout(u),u=setTimeout((function(){u=null,o.apply(void 0,e)}),s)}))}var b=n,h=this.persistOptions.get(t);(null==h?void 0:h.enabled)&&"undefined"!=typeof window&&this.loadFromStorage(t,h).then((function(e){void 0!==e&&i.flows.has(t)&&i.flows.get(t).update(e)})).catch((function(e){console.warn("Failed to load state from storage for key ".concat(t,":"),e)}));var w={getValue:function(){return b},subscribe:function(e,t){return a.set(e,t),t(b),function(){return w.unsubscribe(e)}},unsubscribe:function(e){a.delete(e)},update:function(n){b=n,a.forEach((function(e){return e(n)}));var r=e.getInstance().persistOptions.get(t);if((null==r?void 0:r.enabled)&&"undefined"!=typeof window){var o=e.getInstance().debouncedSaveFunctions.get(t);o&&o(n,r)}},getSubscriberCount:function(){return a.size}};this.flows.set(t,w)}return this.flows.get(t)},e.prototype.get=function(e){return this.flows.get(e)},e.prototype.has=function(e){return this.flows.has(e)},e.prototype.saveToStorage=function(e,t,n){try{if(n.storageType===exports.StorageType.INDEXED_DB){var r=n.serialize(t);l.setValue(n.dbName,n.storeName,n.storageKey,r).catch((function(t){console.warn("Failed to persist state to IndexedDB for key ".concat(e,":"),t)}))}else{r=n.serialize(t);localStorage.setItem(n.storageKey,r)}}catch(t){console.warn("Failed to persist state to storage for key ".concat(e,":"),t)}},e.prototype.loadFromStorage=function(e,t){return a(this,void 0,void 0,(function(){var e,n;return c(this,(function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),t.storageType!==exports.StorageType.INDEXED_DB?[3,2]:[4,l.getValue(t.dbName,t.storeName,t.storageKey)];case 1:return(e=r.sent())?[2,t.deserialize(e)]:[3,3];case 2:if(n=localStorage.getItem(t.storageKey))return[2,t.deserialize(n)];r.label=3;case 3:return[3,5];case 4:throw r.sent();case 5:return[2,void 0]}}))}))},e}();function d(e,t,n){return p.getInstance().getOrCreate(e,t,n)}var b=function(){function e(e){this.isDisposed=!1,this.stateFlow=r({data:e,loading:!1,error:null}),this.eventsFlow=t()}return e.prototype.getState=function(){return this.stateFlow.getValue()},e.prototype.getData=function(){return this.stateFlow.getValue().data},e.prototype.subscribeToState=function(e,t){return this.stateFlow.subscribe(e,t)},e.prototype.subscribeToEvents=function(e,t){return this.eventsFlow.subscribe(e,t)},e.prototype.setLoading=function(e){this.stateFlow.update(i(i({},this.stateFlow.getValue()),{loading:e}))},e.prototype.setError=function(e){this.stateFlow.update(i(i({},this.stateFlow.getValue()),{error:e}))},e.prototype.updateData=function(e){this.stateFlow.update(i(i({},this.stateFlow.getValue()),{data:e}))},e.prototype.updateState=function(e){this.stateFlow.update(i(i({},this.stateFlow.getValue()),e))},e.prototype.emitEvent=function(e){this.eventsFlow.emit(e)},e.prototype.dispose=function(){this.isDisposed||(this.onDispose(),this.isDisposed=!0)},e.prototype.onDispose=function(){},e}(),h=function(){function e(){this.viewModels=new Map}return e.getInstance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.get=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!this.viewModels.has(e)){var o=new(t.bind.apply(t,f([void 0],n,!1)));return this.viewModels.set(e,o),o}return this.viewModels.get(e)},e.prototype.has=function(e){return this.viewModels.has(e)},e.prototype.remove=function(e){if(this.viewModels.has(e)){var t=this.viewModels.get(e);null==t||t.dispose(),this.viewModels.delete(e)}},e.prototype.clear=function(){this.viewModels.forEach((function(e){return e.dispose()})),this.viewModels.clear()},e}();function w(t,n){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];var s=h.getInstance(),u=s.get.apply(s,f([t,n],r,!1)),i=e.useState(u.getState()),a=i[0],c=i[1],l=e.useRef("vm-".concat(t,"-").concat(Math.random()));return e.useEffect((function(){var e=u.subscribeToState(l.current,c);return function(){e()}}),[u]),[a,u]}exports.GlobalSharedFlow=s,exports.GlobalStateFlow=d,exports.SharedFlow=t,exports.StateFlow=r,exports.ViewModel=b,exports.ViewModelProvider=h,exports.useGlobalSharedFlow=function(t,n){var r=s(t);return e.useEffect((function(){var e;return n&&(e=r.subscribe("hook-".concat(t,"-").concat(Math.random()),n)),function(){e&&e()}}),[t,n]),[function(e){return r.emit(e)},function(e){return r.subscribe("sub-".concat(t,"-").concat(Math.random()),e)}]},exports.useGlobalSharedFlowWithState=function(t,n){var r=e.useState(n),o=r[0],u=r[1],i=s(t);return e.useEffect((function(){return i.subscribe("state-".concat(t,"-").concat(Math.random()),(function(e){return u(e)}))}),[t]),[o,function(e){return i.emit(e)}]},exports.useGlobalStateFlow=function(t,n,r){var o=e.useState(n),s=o[0],u=o[1],i=d(t,n,r);return e.useEffect((function(){var e=i.subscribe("hook-".concat(t,"-").concat(Math.random()),(function(e){u(e)}));return u(i.getValue()),e}),[t,n]),[s,function(e){return i.update(e)}]},exports.useGlobalViewModel=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var o="global-".concat(e);return w.apply(void 0,f([o,t],n,!1))},exports.useSharedFlow=n,exports.useSharedFlowWithState=function(t){var r=e.useState(t),o=r[0],s=r[1],u=n();return e.useRef((function(){u.subscribe("internal-state",(function(e){return s(e)}))})).current(),[o,u.emit,function(e){return u.subscribe("sub-".concat(Math.random()),e)}]},exports.useStateFlow=function(t){var n=e.useState(t),r=n[0],o=n[1],s=e.useRef(new Map),u={getValue:function(){return r},subscribe:function(e,t){return s.current.set(e,t),t(r),function(){return u.unsubscribe(e)}},unsubscribe:function(e){s.current.delete(e)},update:function(e){o(e),s.current.forEach((function(t){return t(e)}))},getSubscriberCount:function(){return s.current.size}},i=[r,u.update];return Object.assign(i,u),i},exports.useViewModel=w;
//# sourceMappingURL=index.js.map
